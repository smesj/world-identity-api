# Claude Context - World Identity API

## Project Overview
NestJS API for managing user invitations and identity for the Table Footy project.

## Architecture
- **Framework**: NestJS with TypeScript
- **Database**: PostgreSQL via Prisma ORM
- **Authentication**: Clerk (webhook integration)
- **QR Codes**: qrcode library for generating invitation QR codes

## API Endpoints

### Invitations
- `POST /invitations` - Create new invitation
- `GET /invitations` - List all invitations
- `GET /invitations/:code` - Get invitation by code
- `GET /invitations/validate/:code` - Validate invitation code
- `POST /invitations/use` - Mark invitation as used
- `GET /invitations/:code/qr` - Generate QR code for invitation

### Users
- User management endpoints (integrated with Clerk)

### Webhooks
- Clerk webhook handler for user events

## Production Deployment

### Docker Build
**Important**: Always build for amd64 platform:
```bash
cd /Users/smesj/smesj-workspace/world-identity-api
docker buildx build --platform linux/amd64 -t smesjman/table-footy-api:latest --push .
```

### Environment Variables (Production)
```bash
DATABASE_URL=postgresql://identity:PASSWORD@world-identity-postgres:5432/world_identity
CLERK_SECRET_KEY=sk_live_...
CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_WEBHOOK_SECRET=whsec_...
PORT=3001
NODE_ENV=production
```

**Key Notes**:
- Database host is `world-identity-postgres` (container name on captain-overlay-network)
- Port 3001 must match in both Dockerfile and CapRover config
- Use production Clerk keys

## Database Setup

### PostgreSQL Container
- Name: `world-identity-postgres`
- User: `identity`
- Database: `world_identity`
- Port: 5432 (internal)
- Network: `captain-overlay-network`

### Running Migrations
```bash
# From within the running container or locally with proper DATABASE_URL
npx prisma migrate deploy
```

## CapRover Deployment

### Initial Setup
```bash
ssh 172.16.1.244 'bash -s' << 'ENDSSH'
cat > /tmp/caprover-login.json << 'EOF'
{"password":"CapRover2024!SecurePass"}
EOF

TOKEN=$(curl -s -X POST http://localhost:3000/api/v2/login \
  -H "Content-Type: application/json" \
  -d @/tmp/caprover-login.json | jq -r '.data.token')

# Create app
curl -s -X POST http://localhost:3000/api/v2/user/apps/appDefinitions/register \
  -H "x-captain-auth: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"appName":"table-footy-api","hasPersistentData":false}'

# Deploy image
curl -s -X POST http://localhost:3000/api/v2/user/apps/appData/table-footy-api \
  -H "x-captain-auth: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"captainDefinitionContent":"{\"schemaVersion\":2,\"imageName\":\"smesjman/table-footy-api:latest\"}","gitHash":""}'

# Configure
cat > /tmp/api-config.json << 'EOF'
{
  "appName": "table-footy-api",
  "containerHttpPort": 3001,
  "instanceCount": 1,
  "customDomain": [{"publicDomain": "identity.smesj.world", "hasSsl": false}],
  "envVars": [
    {"key": "DATABASE_URL", "value": "postgresql://identity:PASSWORD@world-identity-postgres:5432/world_identity"},
    {"key": "CLERK_SECRET_KEY", "value": "sk_live_..."},
    {"key": "CLERK_PUBLISHABLE_KEY", "value": "pk_live_..."},
    {"key": "CLERK_WEBHOOK_SECRET", "value": "whsec_..."},
    {"key": "PORT", "value": "3001"},
    {"key": "NODE_ENV", "value": "production"}
  ]
}
EOF

curl -s -X POST http://localhost:3000/api/v2/user/apps/appDefinitions/update \
  -H "x-captain-auth: $TOKEN" \
  -H "Content-Type: application/json" \
  -d @/tmp/api-config.json
ENDSSH
```

### Redeploy After Changes
```bash
# 1. Build and push new image
docker buildx build --platform linux/amd64 -t smesjman/table-footy-api:latest --push .

# 2. Trigger deployment in CapRover
ssh 172.16.1.244 'bash -s' << 'ENDSSH'
cat > /tmp/caprover-login.json << 'EOF'
{"password":"CapRover2024!SecurePass"}
EOF

TOKEN=$(curl -s -X POST http://localhost:3000/api/v2/login \
  -H "Content-Type: application/json" \
  -d @/tmp/caprover-login.json | jq -r '.data.token')

curl -s -X POST http://localhost:3000/api/v2/user/apps/appData/table-footy-api \
  -H "x-captain-auth: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"captainDefinitionContent":"{\"schemaVersion\":2,\"imageName\":\"smesjman/table-footy-api:latest\"}","gitHash":""}'
ENDSSH
```

## Testing Endpoints

```bash
# List invitations
curl https://identity.smesj.world/invitations

# Validate invitation
curl https://identity.smesj.world/invitations/validate/CODE_HERE

# Get QR code
curl https://identity.smesj.world/invitations/CODE_HERE/qr -o qr.png

# Create invitation
curl -X POST https://identity.smesj.world/invitations \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","expiresInDays":7}'
```

## Development

### Local Setup
```bash
# Install dependencies
npm install

# Setup environment
cp .env.example .env
# Edit .env with local database credentials

# Run database
docker-compose up -d

# Run migrations
npx prisma migrate dev

# Start dev server
npm run start:dev
```

### Local Database
```
DATABASE_URL=postgresql://identity:identity_dev_pass@localhost:5433/world_identity
```

## Production URLs
- API: https://identity.smesj.world
- Frontend: http://footy.smesj.world

## Troubleshooting

### Database Connection Issues
- Verify PostgreSQL container is running: `ssh 172.16.1.244 'docker ps | grep postgres'`
- Use container name in DATABASE_URL, not IP address
- Ensure app is on captain-overlay-network

### Prisma Client Issues
- Regenerate client if schema changes: `npx prisma generate`
- Rebuild Docker image after schema changes

### CORS Issues
- CORS is enabled for all origins in production
- Credentials support is enabled

## Key Files
- `/src/main.ts` - App entry point, port configuration (3001)
- `/src/invitations/invitations.controller.ts` - Invitation endpoints
- `/prisma/schema.prisma` - Database schema
- `/Dockerfile` - Multi-stage production build
