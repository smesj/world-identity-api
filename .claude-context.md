# Claude Context - World Identity API

## Project Overview
NestJS API for managing user invitations and identity for the Table Footy project. Integrates with Clerk for authentication and provides QR code generation for invitations.

## Tech Stack
- NestJS with TypeScript
- PostgreSQL 16 via Prisma ORM
- Clerk (authentication & webhooks)
- qrcode library (QR code generation)
- Docker ready

## Local Development

### Setup
```bash
npm install
docker-compose up -d          # Start PostgreSQL
npx prisma migrate dev        # Run migrations
npm run start:dev             # Start dev server
```

### Environment Variables
Create `.env` for local development:
```
DATABASE_URL=postgresql://identity:identity_dev_pass@localhost:5433/world_identity
CLERK_SECRET_KEY=sk_test_YOUR_DEV_KEY
CLERK_PUBLISHABLE_KEY=pk_test_YOUR_DEV_KEY
CLERK_WEBHOOK_SECRET=whsec_YOUR_DEV_SECRET
PORT=3001
NODE_ENV=development
```

**Important:** Use Clerk TEST mode keys for development, LIVE mode for production.

## Production Deployment

### Quick Deploy
```bash
./deploy.sh                   # Deploy latest version
./deploy.sh v1.2.3           # Deploy with version tag
```

### Deployment Script
The `deploy.sh` script:
1. Builds production Docker image (multi-stage build)
2. Pushes to Docker Hub (smesjman/world-identity-api)
3. SSHs to production VM
4. Pulls latest image and restarts container
5. Verifies deployment at https://identity.smesj.world

### Environment Variables (Production)
Production environment is managed on the VM at `/home/smesj/world-identity-api/.env.production`:
```
DATABASE_URL=postgresql://identity:PRODUCTION_PASSWORD@world-identity-postgres:5432/world_identity
CLERK_SECRET_KEY=sk_live_YOUR_PRODUCTION_KEY
CLERK_PUBLISHABLE_KEY=pk_live_YOUR_PRODUCTION_KEY
CLERK_WEBHOOK_SECRET=whsec_YOUR_PRODUCTION_SECRET
PORT=3001
NODE_ENV=production
```

**Never commit `.env.production` to git** - it only exists on the VM.

### Docker Configuration
- **Base Image:** node:20-alpine
- **Exposed Port:** 3001
- **Multi-stage build:** dev → build → prod
- **Prisma:** Client generated during build

### Production Info
- **URL:** https://identity.smesj.world
- **Container Name:** world-identity-api
- **Port Mapping:** 8082:3001
- **VM Location:** 172.16.1.244
- **Database:** world-identity-postgres (linked container)

## API Endpoints

### Invitations
- `POST /invitations` - Create new invitation
  ```json
  {
    "email": "user@example.com",
    "expiresInDays": 7
  }
  ```
- `GET /invitations` - List all invitations
- `GET /invitations/:code` - Get invitation by code
- `GET /invitations/validate/:code` - Validate invitation code
- `POST /invitations/use` - Mark invitation as used
  ```json
  {
    "code": "INVITE123",
    "userId": "clerk_user_id"
  }
  ```
- `GET /invitations/:code/qr` - Generate QR code for invitation

### Users
- User management endpoints (integrated with Clerk)

### Webhooks
- Clerk webhook handler for user events

## Database

### PostgreSQL Container
- **Container Name:** world-identity-postgres
- **User:** identity
- **Database:** world_identity
- **Port:** 5432 (internal)
- **Volume:** Persistent data storage

### Prisma
```bash
# Run migrations
npx prisma migrate dev

# Generate Prisma client
npx prisma generate

# Open Prisma Studio
npx prisma studio
```

### Running Migrations in Production
```bash
ssh 172.16.1.244 'docker exec -it world-identity-api npx prisma migrate deploy'
```

## Testing Endpoints

### Local Testing
```bash
# List invitations
curl http://localhost:3001/invitations

# Create invitation
curl -X POST http://localhost:3001/invitations \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","expiresInDays":7}'

# Validate invitation
curl http://localhost:3001/invitations/validate/CODE_HERE

# Get QR code
curl http://localhost:3001/invitations/CODE_HERE/qr -o qr.png
```

### Production Testing
```bash
# List invitations
curl https://identity.smesj.world/invitations

# Create invitation
curl -X POST https://identity.smesj.world/invitations \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","expiresInDays":7}'
```

## Clerk Integration

### Webhook Configuration
1. Go to Clerk Dashboard → Webhooks
2. Add endpoint: `https://identity.smesj.world/webhooks/clerk`
3. Select events to monitor
4. Copy signing secret to `CLERK_WEBHOOK_SECRET`

### Authentication Flow
1. Frontend uses Clerk for user signup/login
2. Clerk redirects to identity API for invitation validation
3. API validates invitation code
4. Clerk webhook notifies API of new user
5. API marks invitation as used

## Troubleshooting

### Database Connection Issues
```bash
# Check postgres container is running
ssh 172.16.1.244 'docker ps | grep world-identity-postgres'

# View postgres logs
ssh 172.16.1.244 'docker logs world-identity-postgres --tail 50'

# Verify database connection from API container
ssh 172.16.1.244 'docker exec -it world-identity-api npx prisma db pull'
```

### Prisma Client Issues
```bash
# Regenerate Prisma client
npx prisma generate

# Rebuild Docker image after schema changes
./deploy.sh
```

### CORS Issues
- CORS is enabled for all origins in production
- Credentials support is enabled
- Check frontend is using correct API URL

### Deployment Issues
```bash
# Check container logs
ssh 172.16.1.244 'docker logs world-identity-api --tail 50 -f'

# Verify container is running
ssh 172.16.1.244 'docker ps | grep world-identity-api'

# Test endpoint
curl https://identity.smesj.world/invitations
```

## Common Commands

### Development
```bash
npm run start:dev          # Start dev server
npm run build             # Build for production
npm run test              # Run tests
npx prisma studio         # Open database GUI
```

### Deployment
```bash
./deploy.sh               # Deploy to production
```

### Production Management
```bash
# View logs
ssh 172.16.1.244 'docker logs world-identity-api --tail 50 -f'

# Restart container
ssh 172.16.1.244 'docker restart world-identity-api'

# Check status
ssh 172.16.1.244 'docker ps | grep world-identity'

# Run migrations
ssh 172.16.1.244 'docker exec -it world-identity-api npx prisma migrate deploy'
```

## Important Files
- `deploy.sh` - Automated deployment script
- `.env.production.example` - Template for production environment
- `Dockerfile` - Multi-stage production build
- `prisma/schema.prisma` - Database schema
- `src/main.ts` - App entry point, port configuration
- `src/invitations/invitations.controller.ts` - Invitation endpoints
